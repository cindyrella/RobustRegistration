M = 10;
psize = 30;
d = 3;
x = randn(d,psize);
eps = 0.1;
nstep = 20;
stepsize = 0.05;
T = zeros(d,M);

%iterate over different noise level
Err = cell(1,nstep);
for l=1:nstep
    
    %Simulate patches 
    for i=1:M
        t              = 1*randn(d,1)*ones(1,psize); 
        patch(i).idx   = 1:psize;
        noise          = ones(d,1)*binornd(1,stepsize*(l-1),1,psize);
        noise          = 1*randn(d,psize).*noise;
        patch(i).coord = x+noise+t;
        for j=i+1:M
            weight(i,j).w = ones(1,psize);
        end
        T(:,i)= t(:,1);
    end
    
    
    
    %Start IRLS
    [G,Linv,B] = LSSDP(patch,weight,d);
    
    [weight, patch,Tst] = updateweight(patch,Linv,B,M,d,eps,weight,G);
    
    niter = 30;
    oldG = zeros(size(G));
    err = zeros(niter,3);
    for k=1:niter
        err(k,1) = (l-1)*stepsize;
        err(k,2) = norm(G-repmat(eye(d),M,M),'fro');
        err(k,3) = norm(T-Tst,'fro');
        if norm(oldG-G,'fro')<10^-5
            break
        end
        [weight,patch,Tst]     = updateweight(patch,Linv,B,M,d,eps,weight,G);
        eps = eps/3;
        oldG       = G;
        [G,Linv,B] = LSSDP(patch,weight,d);
    end
    err(l,1) = (l-1)*stepsize;
    err(l,2) = norm(G-repmat(eye(d),M,M),'fro')
    err(l,3) = norm(T-Tst,'fro')
end